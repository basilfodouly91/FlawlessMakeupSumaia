<div class="container py-5">
    <!-- Loading State -->
    <div class="text-center" *ngIf="isLoading">
        <div class="spinner-border spinner-pink" role="status">
            <span class="visually-hidden">{{ 'CHECKOUT.TITLE' | translate }}</span>
        </div>
    </div>

    <div class="row" *ngIf="!isLoading && cart">
        <div class="col-lg-8">
            <h1 class="text-pink mb-4">{{ 'CHECKOUT.TITLE' | translate }}</h1>

            <!-- Guest/Login Toggle -->
            <div class="card mb-4" *ngIf="!isAuthenticated">
                <div class="card-body">
                    <h5 class="card-title">{{ 'CHECKOUT.CUSTOMER_INFO' | translate }}</h5>
                    <p class="text-muted">{{ 'CHECKOUT.GUEST_CHECKOUT' | translate }}</p>
                    <button class="btn btn-outline-primary" (click)="goToLogin()">
                        <i class="bi bi-box-arrow-in-right me-2"></i>
                        {{ 'CHECKOUT.LOGIN_CHECKOUT' | translate }}
                    </button>
                </div>
            </div>

            <!-- Customer Information Form -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">{{ 'CHECKOUT.CUSTOMER_INFO' | translate }}</h5>
                    
                    <!-- Guest Information -->
                    <div class="row" *ngIf="!isAuthenticated">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ 'CHECKOUT.EMAIL' | translate }} <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" [(ngModel)]="orderForm.guestEmail" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ 'CHECKOUT.FIRST_NAME' | translate }} <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" [(ngModel)]="orderForm.guestName" required>
                        </div>
                    </div>

                    <!-- Shipping Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ 'CHECKOUT.FIRST_NAME' | translate }} <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" [(ngModel)]="orderForm.shippingFirstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ 'CHECKOUT.LAST_NAME' | translate }} <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" [(ngModel)]="orderForm.shippingLastName" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ 'CHECKOUT.PHONE' | translate }} <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" [(ngModel)]="orderForm.shippingPhone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ 'CHECKOUT.CITY' | translate }} <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" [(ngModel)]="orderForm.shippingCity" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ 'CHECKOUT.ADDRESS' | translate }} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" [(ngModel)]="orderForm.shippingAddress" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ 'CHECKOUT.DELIVERY_NOTES' | translate }}</label>
                        <textarea class="form-control" rows="3" [(ngModel)]="orderForm.notes"></textarea>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">{{ 'CHECKOUT.PAYMENT_METHOD' | translate }}</h5>
                    
                    <!-- Cash on Delivery Option -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="paymentMethod" 
                               id="cashOnDelivery" [(ngModel)]="orderForm.paymentMethod" 
                               value="Cash on Delivery" checked>
                        <label class="form-check-label" for="cashOnDelivery">
                            <i class="bi bi-cash me-2"></i>
                            {{ 'CHECKOUT.CASH_ON_DELIVERY' | translate }}
                        </label>
                    </div>

                    <!-- CliQ Payment Option -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="paymentMethod" 
                               id="cliqPayment" [(ngModel)]="orderForm.paymentMethod" 
                               value="CliQ Payment">
                        <label class="form-check-label" for="cliqPayment">
                            <i class="bi bi-credit-card me-2"></i>
                            {{ 'CHECKOUT.CLIQ_INFO' | translate }}
                        </label>
                    </div>

                    <!-- CliQ Payment Information (Only shown when CliQ is selected) -->
                    <div class="alert alert-info mt-3" *ngIf="orderForm.paymentMethod === 'CliQ Payment'">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="cliq-username">
                                <strong>{{ 'CHECKOUT.CLIQ_USERNAME' | translate }}</strong>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary" (click)="copyCliq()">
                                <i class="bi me-1" [class.bi-check]="cliqCopied" [class.bi-clipboard]="!cliqCopied"></i>
                                {{ cliqCopied ? ('CHECKOUT.COPIED' | translate) : ('CHECKOUT.COPY_CLIQ' | translate) }}
                            </button>
                        </div>

                        <!-- Upload Payment Proof (Required for CliQ) -->
                        <div class="mt-3">
                            <label class="form-label">
                                <i class="bi bi-upload me-2"></i>
                                {{ 'CHECKOUT.UPLOAD_PAYMENT_PROOF' | translate }}
                                <span class="text-danger">*</span>
                            </label>
                            <input type="file" 
                                   id="paymentProofInput"
                                   class="form-control" 
                                   accept="image/*" 
                                   (change)="onPaymentProofSelected($event)"
                                   required>
                            <small class="form-text text-muted">
                                {{ 'CHECKOUT.UPLOAD_PAYMENT_PROOF_HINT' | translate }}
                            </small>

                            <!-- Image Preview -->
                            <div class="mt-3" *ngIf="paymentProofPreview">
                                <div class="payment-proof-preview position-relative">
                                    <img [src]="paymentProofPreview" alt="Payment Proof" class="img-fluid rounded">
                                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" 
                                            (click)="removePaymentProof()">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h5 class="card-title mb-4">{{ 'CHECKOUT.ORDER_SUMMARY' | translate }}</h5>

                    <!-- Cart Items -->
                    <div class="order-items mb-3">
                        <div class="order-item d-flex mb-3" *ngFor="let item of cart.cartItems">
                            <img [src]="item.productImageUrl || 'https://picsum.photos/60/60'" 
                                 [alt]="item.productName" class="me-3" style="width: 60px; height: 60px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ item.productName }}</h6>
                                <small class="text-muted">{{ item.productBrand }}</small>
                                <p class="mb-0">
                                    <small>{{ 'CART.QUANTITY' | translate }}: {{ item.quantity }}</small>
                                </p>
                                <p class="mb-0 fw-bold">{{ item.price * item.quantity | currency:'JOD':'symbol':'1.3-3' }}</p>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Totals -->
                    <div class="d-flex justify-content-between mb-2">
                        <span>{{ 'CHECKOUT.SUBTOTAL' | translate }}</span>
                        <span>{{ getCartSubtotal() | currency:'JOD':'symbol':'1.3-3' }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>{{ 'CHECKOUT.SHIPPING' | translate }}</span>
                        <span>{{ 3 | currency:'JOD':'symbol':'1.3-3' }}</span>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between mb-4">
                        <strong>{{ 'CHECKOUT.TOTAL' | translate }}</strong>
                        <strong class="text-pink">{{ getCartTotal() | currency:'JOD':'symbol':'1.3-3' }}</strong>
                    </div>

                    <!-- Place Order Button -->
                    <button class="btn btn-primary w-100 btn-lg" 
                            (click)="placeOrder()" 
                            [disabled]="isPlacingOrder">
                        <span *ngIf="!isPlacingOrder">
                            <i class="bi bi-check-circle me-2"></i>
                            {{ 'CHECKOUT.PLACE_ORDER' | translate }}
                        </span>
                        <span *ngIf="isPlacingOrder">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            {{ 'CHECKOUT.PLACING_ORDER' | translate }}
                        </span>
                    </button>

                    <div class="text-center mt-3">
                        <a routerLink="/cart" class="text-muted">
                            <i class="bi bi-arrow-left me-2"></i>
                            {{ 'CART.CONTINUE_SHOPPING' | translate }}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

